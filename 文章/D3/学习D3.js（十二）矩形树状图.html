<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <style type="text/css"></style>
  <body>
    <div class="d3Chart"></div>
  </body>
  <!-- D3 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script type="text/javascript">
    const dataTree = {
      name: 'Â§™ÂàÄ',
      children: [
        {
          name: 'ÁüøÁü≥',
          children: [
            {
              name: 'ÁªìÊô∂Ê°Ü',
              children: [
                { name: 'ËìùÁüø', num: 10 },
                { name: 'ÈªëÈìÅÁüø', num: 3 },
                { name: 'ÁôΩÁÅ∞Áüø', num: 4 }
              ]
            }
          ]
        },
        {
          name: 'Êú®Êùê',
          children: [
            {
              name: 'Á®ÄÊú®',
              children: [
                { name: 'Èí¥Êú®', num: 4 },
                { name: 'ÈªëÊú®', num: 2 }
              ]
            },
            {
              name: 'Ê∞¥Êú®',
              children: [{ name: 'ËìùÊú®', num: 4 }]
            }
          ]
        },
        {
          name: 'ÂÆùÁü≥',
          children: [
            {
              name: 'Â§™Èò≥Á±ª',
              children: [
                { name: 'Êó•ÈáëÁü≥', num: 6 },
                { name: 'ÁÜîÂ≤©Áü≥', num: 1 }
              ]
            },
            {
              name: 'Ê∑±Êµ∑Á±ª',
              children: [
                { name: 'ÂØíÈìÅÁü≥', num: 2 },
                { name: 'ÈáëÊô∂Áü≥', num: 3 },
                { name: 'ÁéÑÂÜ∞ÁªìÊô∂', num: 2 }
              ]
            }
          ]
        }
      ]
    }

    var width = 500
    var height = 500
    var margin = 30
    var svg = d3
      .select('.d3Chart')
      .append('svg')
      .attr('width', width)
      .attr('height', height)
      .style('background-color', '#1a3055')
    // Âõæ
    var chart = svg.append('g').attr('transform', `translate(${margin}, ${margin})`)

    // ÁîüÊàêÂ±ÇÊ¨°ÁªìÊûÑÊï∞ÊçÆ - Âπ∂‰∏∫ÂêÑ‰∏™ËäÇÁÇπÊåáÂÆö Â±ÇÊ¨°ÁªìÊûÑÊï∞ÊçÆ
    const rootTree = d3
      .hierarchy(dataTree)
      .sum((d) => d.num) // ËÆ°ÁÆóÁªòÂõæÂ±ûÊÄßvalueÁöÑÂÄº  -Ê±ÇÂíå ÂÖ∂Â≠êËäÇÁÇπÊâÄÊúâ.numÂ±ûÊÄßÁöÑÂíåÂÄº
      .sort((a, b) => a.value - b.value) // Ê†πÊçÆ ‰∏äÈù¢ËÆ°ÁÆóÂá∫ÁöÑ valueÂ±ûÊÄß ÊéíÂ∫è
    // console.log('üöÄ ~ file: Â≠¶‰π†D3.jsÔºàÂçÅ‰∫åÔºâÁü©ÂΩ¢Ê†ëÁä∂Âõæ.html ~ line 88 ~ rootTree', rootTree)

    // Ê†πÊçÆ ÊØè‰∏™ËäÇÁÇπÁöÑÂÄºÈÄíÂΩíÁöÑÂ∞ÜÂå∫ÂüüÂàíÂàÜ‰∏∫Áü©ÂΩ¢ Âπ∂ÁîüÊàêÁªòÂõæÊï∞ÊçÆ
    // .size() ËÆæÁΩÆÁü©ÂΩ¢ÁöÑÂ∏ÉÂ±ÄÂ∞∫ÂØ∏
    // .round() ÂêØÁî®ÊàñÁ¶ÅÁî®ÂõõËàç‰∫îÂÖ•
    // .padding() ËÆæÁΩÆÂ∏ÉÂ±ÄÈó¥Èöî
    const TreeMap = d3
      .treemap()
      .size([width - 2 * margin, height - 2 * margin])
      .round(true)
      .padding(1)(rootTree)
    // console.log('üöÄ ~ file: Â≠¶‰π†D3.jsÔºàÂçÅ‰∫åÔºâÁü©ÂΩ¢Ê†ëÁä∂Âõæ.html ~ line 99 ~ TreeMap', TreeMap)
    // leaves
    // console.log('üöÄ ~ file: Â≠¶‰π†D3.jsÔºàÂçÅ‰∫åÔºâÁü©ÂΩ¢Ê†ëÁä∂Âõæ.html ~ line 86 ~ TreeMap', rootTree.descendants())

    var colorScale = d3.scaleOrdinal(d3.schemeSet3)
    // console.log('üöÄ ~ file: Â≠¶‰π†D3.jsÔºàÂçÅ‰∫åÔºâÁü©ÂΩ¢Ê†ëÁä∂Âõæ.html ~ line 104 ~ d3.schemeSet3', d3.schemeSet3)

    // Áü©ÂΩ¢ÁªòÂà∂ÁªÑ
    const rectChart = chart.append('g')

    rectChart
      .selectAll()
      .data(rootTree.leaves())
      .enter()
      .append('rect')
      .attr('class', 'cell')
      .attr('x', (d) => d.x0)
      .attr('y', (d) => d.y0)
      .attr('width', (d) => d.x1 - d.x0)
      .attr('height', (d) => d.y1 - d.y0)
      .attr('fill', (d, i) => colorScale(i))

    rectChart
      .selectAll()
      .data(rootTree.leaves())
      .enter()
      .append('text')
      .attr('class', 'cellText')
      .attr('transform', (d) => 'translate(' + (d.x0 + d.x1) / 2 + ',' + ((d.y0 + d.y1) / 2 + 6) + ')')
      .attr('fill', '#555555')
      .attr('text-anchor', 'middle')
      .text((d) => d.data.name)
      .text(function (d) {
        if (textWidthIsOk(d, this)) {
          return d.data.name
        } else {
          return '...'
        }
      })
    // Ê£ÄÊµãÊñáÊú¨ÈïøÂ∫¶ÊòØÂê¶ÂêàÈÄÇ
    function textWidthIsOk(d, text) {
      const textWidth = text.getBBox().width
      if (d.x1 - d.x0 >= textWidth) return true
      return false
    }

    var tooltips = d3
      .select('body')
      .append('div')
      .style('width', 'auto')
      .style('height', '40px')
      .style('background-color', '#fff')
      .style('dispaly', 'flex')
      .style('justify-content', 'center')
      .style('padding', '10px')
      .style('border-radius', '5px')
      .style('opacity', 0)

    d3.selectAll('.cell,.cellText')
      .on('mouseover', function (e, d) {
        tooltips
          .html(`ÊùêÊñôÔºö${d.data.name}<br /> Êï∞ÈáèÔºö${d.value}`)
          .style('position', 'absolute')
          .style('left', `${e.clientX}px`)
          .style('top', `${e.clientY}px`)
          .style('opacity', 1)
      })
      .on('mouseleave', function (e, d) {
        tooltips.style('opacity', 0).style('left', `0px`).style('top', `0px`)
      })
  </script>
</html>
